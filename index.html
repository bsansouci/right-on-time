<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="./client.js"></script>
</head>
<body style="width: 1000px;height:1000px;position: absolute;">
<button id="play-button">Load track plz!</button>

<script>
    var socket = io.connect('http://192.168.1.101:8080/');

    // var arrayOfSlices = [];
    var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var song = audioCtx.createBufferSource();
    var cachedBuffer = null;
    socket.on('server-ready', function (data) {
      // socket.on("track-buffer-data", function(data) {
      //   arrayOfSlices.push(data.buffer);
      // });
      socket.on("track-buffer-data-end", function(track) {
        // var totalLength = arrayOfSlices.reduce(function(acc, v) {
        //   return acc + v.byteLength;
        // }, 0);
        // console.log(totalLength);
        // var track = new Uint8Array(totalLength);

        // var acc = 0;
        // for (var i = 0; i < arrayOfSlices.length; i++) {
        //   track.set(new Uint8Array(arrayOfSlices[i]), acc);
        //   acc += arrayOfSlices[i].byteLength;
        // }

        audioCtx.decodeAudioData(track.buffer, function(buffer) {
          song.buffer = buffer;
          cachedBuffer = buffer;
          song.connect(audioCtx.destination);
          console.log("track loaded");
          document.getElementById("play-button").textContent = "Ready!";
          document.getElementById("play-button").removeEventListener('click', arguments.callee, false);
          document.getElementById("play-button").addEventListener("click", function() {
            // Start, then stop, then reset the bufferSource so that iOS
            // allows a non touch event to start the audio playback
            song.start(0);
            song.stop(0);
            song = audioCtx.createBufferSource();
            song.buffer = cachedBuffer;
            song.connect(audioCtx.destination);

            document.getElementById("play-button").textContent = "Play";
            socket.on("play", function(timestamp) {
              console.log("receive play from server, playing in", (timestamp - Date.now())/1000);
              song.start((timestamp - Date.now())/1000);
              var div = document.createElement("div");
              div.textContent = timestamp + " | " + (timestamp - Date.now())/1000;
              document.body.appendChild(div);

              document.getElementById("play-button").textContent = "Stop (can't restart afterwards)";
              playing = true;
            });

            var playing = false;
            document.getElementById("play-button").addEventListener("click", function() {
              if(playing) {
                song.stop(0);
                document.getElementById("play-button").textContent = "Play";
              } else {
                console.log("sending play to server");
                var timestamp = Date.now() + 2000;
                socket.emit("play", timestamp);
                console.log((timestamp - Date.now())/1000);
                song.start((timestamp - Date.now())/1000);
                var div = document.createElement("div");
                div.textContent = timestamp + " | " + (timestamp - Date.now())/1000;
                document.body.appendChild(div);

                document.getElementById("play-button").textContent = "Stop (can't restart afterwards)";
              }
              playing = !playing;
            });
          });
        }, function(e) {
          console.error(e);
        });
      });

      document.getElementById("play-button").addEventListener("click", function() {
        socket.emit("load-track", 190874710);
        document.getElementById("play-button").removeEventListener('click', arguments.callee, false);
      });
      // var music = new WebAudioAPISound("music/rider-in-red", function() {
      //   console.log("Done loading.");

      //   document.getElementById("play-button").disabled = false;
      //   document.getElementById("play-button").addEventListener('click', function () {
      //     document.getElementById("play-button").textContent = "Play";
      //     // Start playing audio when the user clicks anywhere on the page,
      //     // to force Mobile Safari to load the audio.
      //     document.getElementById("play-button").removeEventListener('click', arguments.callee, false);

      //     music.play(0);
      //     music.stop(0);

          // var play = function() {
          //   var timestamp = Date.now() + 2000;
          //   socket.emit("play", timestamp);
          //   music.play(timestamp - Date.now());
          //   var div = document.createElement("div");
          //   div.textContent = timestamp + " | " + (timestamp - Date.now());
          //   document.body.appendChild(div);
          // };

          // socket.on("play", function(timestamp) {
          //   console.log(timestamp, Date.now() - timestamp);

          //   music.play(timestamp - Date.now());
          //   var div = document.createElement("div");
          //   div.textContent = timestamp + " | " + (timestamp - Date.now());
          //   document.body.appendChild(div);
          // });

      //     document.getElementById("play-button").addEventListener('click', play, false);
      //   }, false);

      // });

    });
  </script>
</body>
</html>